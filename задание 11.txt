





Мои курсы

Подарок за друга

Задание на одиннадцатый спринт
В этом уроке вы познакомитесь с проектной работой одиннадцатого спринта. Это поможет вам оценить её сложность и распланировать своё время.
Как обычно, вам не нужно выполнять задание прямо сейчас.
В конце спринта будет ещё один урок с проектной работой. Там мы повторим описание задания и дадим форму, куда нужно отправить ваши решения.
Мы предлагаем вам посмотреть на задание заранее, чтобы вы могли распланировать своё время. Но делать это необязательно. Если вы хотите сначала изучить теорию, пропустите этот урок и переходите к следующему!

Задание
Доработайте ваше микросервисное приложение «Банк»:
Добавьте в проект распределённую платформу Apache Kafka.
Реализуйте отправку уведомлений в сервис Notifications через Apache Kafka.
Реализуйте взаимодействие между сервисами Exchange и Exchange Generator через Apache Kafka.
Требования к приложению
Аналогичны требованиям из задания десятого спринта, но с изменениями/дополнениями:
В проект должна быть добавлена платформа Apache Kafka.
Платформа Apache Kafka должна быть развёрнута в Kubernetes с использованием Helm.
Платформа Apache Kafka может быть развёрнута в каждом из пространств имён Kubernetes (dev, test, prod в зависимости от того, какие окружения использовались при развёртывании микросервисов) или же в единственном экземпляре в своём пространстве имён (например, default), при этом к ней должны иметь доступ микросервисы.
Платформа Apache Kafka должна быть развёрнута на двух нодах, которые должны быть объединены в кластер (при недостаточности ресурсов допускается развёртывание на одной ноде).
При остановке/перезапуске/падении подов содержимое топиков, добавленных в Apache Kafka, не должно удаляться.
Взаимодействие с микросервисом Notifications должно происходить без использования REST, но с использованием платформы Apache Kafka:
Должны быть заведены соответствующие топики на нодах кластера (или на одной ноде, если Apache Kafka развёрнута только на одной).
Должна быть реализована отправка сообщений в соответствии со стратегией At least once.
Допускается не поддерживать очерёдность отправки сообщений (unordered messages).
При перезапуске/падении микросервис Notifications должен начинать обрабатывать сообщения с последнего прочитанного сообщения.
Должны быть написаны соответствующие тесты на интеграцию с Apache Kafka и на взаимодействие между микросервисами через неё.
Взаимодействие между микросервисами Exchange и Exchange Generator должно происходить без использования REST, но с использованием платформы Apache Kafka:
Должны быть заведены соответствующие топики на нодах кластера (или на одной ноде, если Apache Kafka развёрнута только на одной).
Должна быть реализована отправка сообщений в соответствии со стратегией At most once.
Необходимо поддерживать очерёдность отправки сообщений (ordered messages).
При перезапуске/падении микросервис Exchange может обрабатывать сообщения начиная с последнего (то есть пропустить предыдущие, так как они уже неактуальны).
Должны быть написаны соответствующие тесты на интеграцию с Apache Kafka и на взаимодействие между микросервисами через неё.
Развёртывание и обновление платформы Apache Kafka, а также её конфигураций, топиков и т. д. должны осуществляться через отдельный пайплайн и пайплайн umbrella-проекта (Jenkinsfile) в CI/CD Jenkins.
Jenkinsfile должны храниться в Git, и должна быть возможность их применения в CI/CD Jenkins.
Функциональность
Аналогична функциональности из задания десятого спринта с некоторыми изменениями (выделены в тексте полужирным шрифтом):
Микросервисное приложение «Банк» — это приложение с веб-интерфейсом, которое позволяет пользователю (клиенту банка):
регистрироваться в системе по логину и паролю (заводить аккаунт);
добавлять счета в различных валютах для аккаунта;
класть виртуальные деньги на счёт и снимать их;
переводить деньги между своими счетами с учётом конвертации в различные валюты;
переводить деньги на другой счёт с учётом конвертации в различные валюты.
Приложение состоит из следующих микросервисов:
фронта (Front UI);
сервиса аккаунтов (Accounts);
сервиса обналичивания денег (Cash);
сервиса перевода денег между счетами одного или двух аккаунтов (Transfer);
сервиса конвертации валют (Exchange);
сервиса генерации курсов валют (Exchange Generator);
сервиса блокировки подозрительных операций (Blocker);
сервиса уведомлений (Notifications).
Фронт (Front UI)
Фронт (Front UI) — это веб-приложение с клиентским HTML-интерфейсом. Предоставляет следующие HTML-страницы:
Страницу ввода логина/пароля.
Можно предусмотреть аутентификацию remember-me. Можно использовать дефолтную страницу, которую предоставляет Spring Security.
Страница содержит:
поле ввода логина;
поле ввода пароля;
кнопку «Войти», при нажатии на которую происходят аутентификация/авторизация пользователя и редирект на главную страницу.
Страницу выхода из приложения (разлогинивания). 
Можно использовать дефолтную страницу, которую предоставляет Spring Security. 
Страница содержит ссылку, при нажатии на которую:
пользователь разлогинивается;
происходит редирект на страницу ввода логина/пароля.
Страницу регистрации пользователя в приложении (нового аккаунта).
Страница содержит:
поля ввода фамилии, имени, почты (если планируется отправлять уведомления на почту), даты рождения;
поля ввода логина и пароля;
кнопку «Зарегистрироваться», при нажатии на которую происходит проверка введённых данных и создаётся новый аккаунт с автоматической аутентификацией/авторизацией пользователя и редиректом на главную страницу (должна быть предусмотрена валидация: все поля заполнены, возраст старше 18 лет).
Главную страницу, которая доступна только после успешной аутентификации/авторизации пользователя. 
Страница содержит:
блок настроек аккаунта;
блок внесения и снятия виртуальных денег;
блок перевода денег между своими счетами;
блок перевода денег на счёт другого аккаунта;
блок курсов валют.
Блок настроек аккаунта
Состоит из:
логина пользователя без возможности редактирования, но с возможностью удаления (если есть хотя бы один ненулевой счёт, то должна появляться ошибка);
поля ввода нового пароля и кнопки «Изменить пароль», при нажатии на которую меняется пароль пользователя (пароль должен быть непустой);
фамилии, имени, почты (если предполагается отправлять уведомления на почту) и даты рождения с возможностью их редактирования (должна быть предусмотрена валидация: все поля заполнены, возраст старше 18 лет);
списка счетов пользователя с возможностью их добавления, редактирования и удаления (у пользователя может быть не более одного счёта в определённой валюте);
ссылки на страницу разлогинивания.
Блок внесения и снятия виртуальных денег
Состоит из:
поля выбора счёта (обязательно);
поля ввода суммы снятия (обязательно);
кнопок «Положить» и «Снять» (если сумма, которую нужно снять, больше суммы на счёте, то должна появляться ошибка).
Блок перевода денег между своими счетами
Состоит из:
поля выбора своего счёта для отправки денег (обязательно);
поля выбора своего счёта для получения (обязательно);
поля ввода суммы перевода (если сумма больше суммы на счёте отправления, то должна появляться ошибка);
кнопки, при нажатии на которую осуществляется перевод денег.
Блок перевода денег на счёт другого аккаунта
Состоит из:
поля выбора своего счёта для отправки денег (обязательно);
поля выбора счёта получателя (обязательно, с поиском по аккаунту);
поля ввода суммы перевода (если сумма больше суммы на счёте отправления, то должна появляться ошибка);
кнопки, при нажатии на которую осуществляется перевод денег.
Блок курсов валют
Первый столбец таблицы — валюта.
Второй столбец — покупка.
Третий столбец — продажа.
Сервис аккаунтов (Accounts)
Сервис аккаунтов хранит информацию о зарегистрированных аккаунтах и счетах в каждом из них (именно в нём хранятся логин/пароль, которые проверяются при аутентификации пользователя).
Фронт выполняет REST-запросы (в формате JSON) из блока настроек аккаунта в сервис Accounts при получении данных аккаунта и данных о счетах, редактировании их, добавлении и удалении.
В свою очередь, Accounts отправляет сообщения о нотификации (в формате JSON) в соответствующий топик платформы Apache Kafka, который читает сервис Notifications.
Также в Accounts приходят запросы при регистрации нового аккаунта (из формы регистрации).
Сервис обналичивания денег (Cash)
Сервис обналичивания денег осуществляет пополнение счёта или снятие денег со счёта.
Фронт выполняет REST-запросы (в формате JSON) из блока внесения и снятия виртуальных денег в сервис Cash.
В свою очередь, Cash выполняет REST-запросы (в формате JSON) в Accounts и Blocker.
Также Cash отправляет сообщения о нотификации (в формате JSON) в соответствующий топик платформы Apache Kafka, который читает сервис Notifications.
Сервис перевода денег между счетами (Transfer)
Сервис перевода денег между счетами осуществляет перевод денег между счетами одного пользователя и между счетами разных пользователей.
Фронт выполняет REST-запросы (в формате JSON) из блока перевода денег между своими счетами и блока перевода денег на счёт другого аккаунта в сервис Transfer.
В свою очередь, Transfer выполняет REST-запросы (в формате JSON) в Accounts, Exchange и Blocker.
Также Transfer отправляет сообщения о нотификации (в формате JSON) в соответствующий топик платформы Apache Kafka, который читает сервис Notifications.
Сервис конвертации валют (Exchange)
Сервис конвертации валют хранит информацию о конвертации валюты при её покупке/продаже (базовой валютой считается RUB, её конвертация при продаже/покупке равна 1).
Фронт выполняет REST-запросы (в формате JSON) из блока курсов валют в сервис Exchange для получения информации о курсах валют.
Сервис Exchange читает сообщения с информацией о конвертации валют (в формате JSON) из соответствующего топика платформы Apache Kafka и сохраняет их у себя.
Сервис генерации курсов валют (Exchange Generator)
Сервис генерации курсов валют каждую секунду по расписанию генерирует курсы валют (алгоритм на ваш выбор: Round Robin из файла, БД, случайные значения и т. д.) и отправляет сообщения с информацией о конвертации валют (в формате JSON) в соответствующий топик платформы Apache Kafka, который читает сервис Exchange.
Валют должно быть не меньше трёх: RUB, USD, CNY. Базовой валютой считается RUB, то есть при конвертации, например, из USD в CNY сначала USD конвертируется в RUB, а потом RUB в CNY.
Сервис блокировки подозрительных операций (Blocker)
Сервис блокировки подозрительных операций отслеживает подозрительные операции (алгоритм на ваш выбор: случайно, в зависимости от текущего времени и т. д.).
Сервис уведомлений (Notifications)
Сервис уведомлений читает сообщения о нотификации (в формате JSON) из соответствующего топика платформы Apache Kafka и отправляет уведомления (на ваш выбор: на почту, выдаёт Alert и т. д.) пользователю о выполненном действии: переводе денег, пополнении счёта, снятии денег со счёта и т. д.
Итоговая схема взаимодействия сервисов выглядит следующим образом:

Микросервисы должны аутентифицироваться/авторизовываться на сервере авторизации по client credentials, чтобы выполнять запросы в другие микросервисы. У одного микросервиса может не быть доступа к выполнению запросов в другой микросервис (например, микросервис Exchange не может выполнять запросы в Accounts).
Аутентификация/авторизация пользователей должна быть по логину/паролю. У пользователя есть доступ к информации только о своём аккаунте и счетах.
Как работать над заданием
Задание должно быть продолжением/развитием микросервисного приложения «Банк» из десятого спринта.
Изучить описание задания по изменению/доработке микросервисного приложения:
сохранена история коммитов проекта;
внедрена платформа Apache Kafka для взаимодействия микросервисов;
платформа Apache Kafka разворачивается в Kubernetes с использованием Helm-чартов;
взаимодействия с сервисом Notifications не используют REST, обмен сообщениями осуществляется через соответствующий топик Apache Kafka;
взаимодействие между сервисами Exchange и Exchange Generator не использует REST, обмен сообщениями осуществляется через соответствующий топик Apache Kafka;
написан Jenkinsfile для развёртывания/обновления платформы Apache Kafka, её конфигурации, топиков и т. д.;
доработан Jenkinsfile для всего зонтичного проекта: в него добавлена возможность развёртывания/обновления платформы Apache Kafka, её конфигурации, топиков и т. д.;
Jenkinsfile применены в CI/CD Jenkins и хранятся в Git.
После изучения задания изменить/доработать микросервисное приложение в соответствии с требованиями проекта.
Стараться использовать микрокоммиты при разработке приложения.
В финальном коммите проставить тег v3.0 и сделать пуш на GitHub.
Шаги по разработке приложения
Добавить Jenkinsfile для развёртывания платформы Apache Kafka, её обновления, изменения конфигурации, топиков и т. д. в Kubernetes с использованием Helm.
Доработать Jenkinsfile umbrella-проекта для развёртывания платформы Apache Kafka, её обновления, изменения конфигурации, топиков и т. д. в Kubernetes с использованием Helm.
Сохранить Jenkinsfile в Git.
Добавить в сервисы Accounts, Cash, Transfer, Notifications, Exchange, Exchange Generator соответствующий Spring Boot Starter для взаимодействия с Apache Kafka (и другие необходимые зависимости).
Удалить из сервиса Notifications зависимости Spring Web MVC / WebFlux, так как взаимодействие с ним будет осуществляться только через Apache Kafka.
Удалить из сервисов, в которых не требуется выполнять REST-запросы в другие сервисы, ненужные зависимости, связанные с выполнением REST-запросов.
Настройки продюсеров/консьюмеров сообщений из топиков Apache Kafka написать в соответствующих ConfigMaps микросервисов.
Удалить ненужные тесты и добавить интеграционные и контрактные тесты на использование платформы Apache Kafka для взаимодействия микросервисов.
Изменить, если требуется, тесты на Helm-чарты.
10. Отредактировать README.md: написать, как собирать и запускать приложение в среде разработки и локально, как применять Jenkinsfile в CI/CD Jenkins для развёртывания микросервисов и платформы Apache Kafka в Kubernetes.
11. В процессе разработки приложения делать микрокоммиты в Git.
12. В финальном коммите проставить тег v3.0 и сделать пуш на GitHub.
Что проверит ревьюер
Аналогично требованиям проекта десятого спринта с дополнениями:
правильность использования Helm-чартов с платформой Apache Kafka для её развёртывания в Kubernetes;
правильность написания Jenkinsfile для развёртывания/обновления платформы Apache Kafka, её конфигурации, топиков и т. д.;
правильность изменения Jenkinsfile umbrella-проекта для развёртывания/обновления платформы Apache Kafka, её конфигурации, топиков и т. д.;
правильность настроек топиков, продюсеров и консьюмеров в соответствии с требованиями проекта;
правильность взаимодействия микросервисов в соответствии с требованиями проекта;
правильность использования возможностей интеграции Spring Boot приложений с платформой Apache Kafka;
правильность написания модульных и интеграционных тестов;
подробность и понятность описания проекта в README.md, форматирование;
использование микрокоммитов при разработке приложения;
правильное использование rebase/merge-слияний в истории проекта;
тесты приложения при прогоне «зелёные».
Что не нужно делать (так как будет в следующем спринте)
Агрегировать, хранить и анализировать логи (ELK-стек).
Настраивать Health Check, мониторинг микросервисов, аудит.
Настраивать распределённые трассировки.
Как вам урок?




Краткий пересказ урока

К следующей теме
Стриминговая платформа Apache Kafka

