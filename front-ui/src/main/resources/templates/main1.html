<!DOCTYPE html>
<html lang="ru" xmlns:th="http://www.thymeleaf.org">

<head>
    <title>Банковское приложение</title>
    <script language="JavaScript">
        setInterval(() => {
            var td = document.getElementById('exchange_rates');
            fetch('/api/exchange/rates')
                .then(response => response.json())
                .then(json => {
                    var table = '<table style="width:100%;margin-left:auto;margin-right:auto;border-radius:2%;padding:10px;background-color:whitesmoke;">';
                    table += '<tr><th colspan="3">Курсы валют по отношению к рублю</th></tr>';
                    table += '<tr><th>Валюта</th><th>Обозначение</th><th>Курс</th></tr>';
                    json.forEach(rate => {
                        table += '<tr>';
                        table += '<td>' + (rate.title || '') + '</td>';
                        table += '<td>' + (rate.name || '') + '</td>';
                        table += '<td>' + (rate.value || '') + '</td>';
                        table += '</tr>';
                    });
                    table += '</table>';
                    td.innerHTML = table;
                })
                .catch(error => td.innerHTML = 'Ошибка при получении данных курсов валют');
        }, 10000);
    </script>
    <script th:inline="javascript">
        /*<![CDATA[*/

        // Данные балансов из Thymeleaf с защитой от null
        var balances = {};
        <th:block th:each="account : ${accounts}">
            <th:block th:if="${account != null and account.currency != null}">
            balances[[${account.currency}]] = [[${account.balance ?: '0.00'}]];
            </th:block>
        </th:block>

        function updateBalance() {
            var currencySelect = document.getElementById('currencySelect');
            var selectedCurrency = currencySelect ? currencySelect.value : '';
            var balanceDisplay = document.getElementById('balanceDisplay');

            if (selectedCurrency && balances[selectedCurrency] !== undefined) {
                balanceDisplay.innerHTML = 'Баланс: ' + balances[selectedCurrency];
            } else {
                balanceDisplay.innerHTML = 'Баланс: 0.00';
            }
        }

        // Инициализация при загрузке страницы
        document.addEventListener('DOMContentLoaded', function() {
            updateBalance();
        });

        /*]]>*/
    </script>
</head>

<body>
<a href="/signup" style="float:right;">
    <b>РЕГИСТРАЦИЯ &plus;</b>
</a>
<br>
<form method="post" action="/logout" style="float:right; display:inline;">
    <input type="hidden" name="_csrf" th:value="${_csrf.token}"/>
    <button type="submit" style="background:none; border:none; color:blue; cursor:pointer; padding:0; font:inherit;">
        <b>ВЫЙТИ &cudarrr;</b>
    </button>
</form>
<table style="width:70%;margin-left:auto;margin-right:auto;">
    <tr><td style="padding:2px;">
        <form method="post" th:action="${'/api/accounts/' + login + '/password'}">
            <table style="width:100%;margin-left:auto;margin-right:auto;border-radius:2%;padding:10px;background-color:whitesmoke;">
                <tr>
                    <td style="font-weight:bold;">Логин</td>
                    <td colspan="2" th:text="${login} ?: 'Не указан'"></td>
                </tr>
                <tr>
                    <td style="font-weight:bold;">Изменить пароль</td>
                    <td>
                        <p style="color:red;" th:if="${passwordErrors != null}"
                           th:each="passwordError : ${passwordErrors}"
                           th:text="${passwordError}"></p>
                        <p>
                            Пароль: <input name="password" type="password" required/>
                        </p>
                        <p>
                            Повторите пароль: <input name="confirm_password" type="password" required/>
                        </p>
                    </td>
                    <td style="text-align:right">
                        <button>Изменить пароль</button>
                    </td>
                </tr>
            </table>
        </form>
    </td></tr>
    <tr><td style="padding:2px;">
        <form method="post" th:action="${'/api/accounts/' + login + '/profile'}">
            <table style="width:100%;margin-left:auto;margin-right:auto;border-radius:2%;padding:10px;background-color:whitesmoke;">
                <tr th:if="${userAccountsErrors != null}">
                    <td style="color:red;" colspan="3"
                        th:each="userAccountsError : ${userAccountsErrors}"
                        th:text="${userAccountsError}"></td>
                </tr>
                <tr>
                    <td style="font-weight:bold;">Фамилия Имя</td>
                    <td th:text="${name} ?: 'Не указано'"></td>
                    <td>
                        <input name="name" type="text" style="width:100%" th:value="${name}"/>
                    </td>
                </tr>
                <tr>
                    <td style="font-weight:bold;">Дата рождения</td>
                    <td th:text="${birthdate} ?: 'Не указана'"></td>
                    <td>
                        <input name="birthdate" type="date" style="width:100%" th:value="${birthdate}"/>
                    </td>
                </tr>
                <th:block th:if="${not #lists.isEmpty(accounts)}">
                    <tr th:each="account : ${accounts}" th:if="${account != null and account.currency != null}">
                        <td style="font-weight:bold;">
                            <span th:text="${account.currency} ?: 'Валюта'"></span>                        </td>
                        <td th:text="'$' + (${account.balance} ?: '0.00') + ' ' + (${account.currency} ?: '')"></td>
                        <td style="text-align:right">
                            <input name="account" type="checkbox"
                                   th:checked="${account.balance != null}"
                                   th:value="${account.currency} ?: ''"/>
                        </td>
                    </tr>
                </th:block>
                <tr th:if="${#lists.isEmpty(accounts)}">
                    <td colspan="3" style="text-align:center; color: gray;">
                        Счета не найдены
                    </td>
                </tr>
                <tr>
                    <td style="text-align:right" colspan="3">
                        <button>Сохранить изменения</button>
                    </td>
                </tr>
            </table>
        </form>
    </td></tr>
    <tr><td style="padding:2px;">
        <form method="post" th:action="${'/user/' + login + '/cash'}">
            <table style="width:100%;margin-left:auto;margin-right:auto;border-radius:2%;padding:10px;background-color:whitesmoke;">
                <tr th:if="${cashErrors != null}">
                    <td style="color:red;" colspan="4"
                        th:each="cashError : ${cashErrors}"
                        th:text="${cashError}"></td>
                </tr>
                <tr>
                    <td style="font-weight:bold;">Наличные</td>
                    <td>
                        Валюта
                        <select name="currency" id="currencySelect" onchange="updateBalance()">
                            <th:block th:if="${not #lists.isEmpty(currency)}">
                                <option th:each="eachCurrency : ${currency}"
                                        th:value="${eachCurrency.name()}"
                                        th:text="${eachCurrency.getTitle()} ?: eachCurrency.name()"></option>
                            </th:block>
                            <th:block th:if="${#lists.isEmpty(currency)}">
                                <option value="">Нет валют</option>
                            </th:block>
                        </select>
                        <br/>
                        <span id="balanceDisplay" style="font-size:12px; color:green;">
                            Баланс: 0.00
                        </span>
                    </td>
                    <td>
                        <input name="value" type="number" style="width:100%" required min="0.01" step="0.01"/>
                    </td>
                    <td style="text-align:right">
                        <button name="action" value="PUT">Положить</button>
                        <button name="action" value="GET">Снять</button>
                    </td>
                </tr>
            </table>
        </form>
    </td></tr>
    <tr><td style="padding:2px;">
        <form method="post" th:action="${'/user/' + login + '/transfer'}">
            <table style="width:100%;margin-left:auto;margin-right:auto;border-radius:2%;padding:10px;background-color:whitesmoke;">
                <tr th:if="${transferErrors != null}">
                    <td style="color:red;" colspan="5"
                        th:each="transferError : ${transferErrors}"
                        th:text="${transferError}"></td>
                </tr>
                <tr>
                    <td style="font-weight:bold;">Перевод себе</td>
                    <td>
                        Со счета
                        <select name="from_currency">
                            <th:block th:if="${not #lists.isEmpty(currency)}">
                                <option th:each="eachCurrency : ${currency}"
                                        th:value="${eachCurrency.name()}"
                                        th:text="${eachCurrency.getTitle()} ?: eachCurrency.name()"></option>
                            </th:block>
                        </select>
                    </td>
                    <td>
                        На счет
                        <select name="to_currency">
                            <th:block th:if="${not #lists.isEmpty(currency)}">
                                <option th:each="eachCurrency : ${currency}"
                                        th:value="${eachCurrency.name()}"
                                        th:text="${eachCurrency.getTitle()} ?: eachCurrency.name()"></option>
                            </th:block>
                        </select>
                    </td>
                    <td>
                        <input name="value" type="number" style="width:100%" required min="0.01" step="0.01"/>
                    </td>
                    <td style="text-align:right">
                        <input hidden name="to_login" th:value="${login}"/>
                        <button>Перевести</button>
                    </td>
                </tr>
            </table>
        </form>
    </td></tr>
    <tr><td style="padding:2px;">
        <form method="post" th:action="${'/user/' + login + '/transfer'}">
            <table style="width:100%;margin-left:auto;margin-right:auto;border-radius:2%;padding:10px;background-color:whitesmoke;">
                <tr th:if="${transferOtherErrors != null}">
                    <td style="color:red;" colspan="6"
                        th:each="transferOtherError : ${transferOtherErrors}"
                        th:text="${transferOtherError}"></td>
                </tr>
                <tr>
                    <td style="font-weight:bold;">Перевод другому</td>
                    <td>
                        Со счета
                        <select name="from_currency">
                            <th:block th:if="${not #lists.isEmpty(currency)}">
                                <option th:each="eachCurrency : ${currency}"
                                        th:value="${eachCurrency.name()}"
                                        th:text="${eachCurrency.getTitle()} ?: eachCurrency.name()"></option>
                            </th:block>
                        </select>
                    </td>
                    <td>
                        На счет
                        <select name="to_currency">
                            <th:block th:if="${not #lists.isEmpty(currency)}">
                                <option th:each="eachCurrency : ${currency}"
                                        th:value="${eachCurrency.name()}"
                                        th:text="${eachCurrency.getTitle()} ?: eachCurrency.name()"></option>
                            </th:block>
                        </select>
                    </td>
                    <td>
                        <input name="value" type="number" required min="0.01" step="0.01"/>
                    </td>
                    <td>
                        Кому
                        <select name="to_login">
                            <th:block th:if="${not #lists.isEmpty(users)}">
                                <option th:each="user : ${users}"
                                        th:value="${user.login}"
                                        th:text="${user.name} ?: user.login"></option>
                            </th:block>
                            <th:block th:if="${#lists.isEmpty(users)}">
                                <option value="">Нет пользователей</option>
                            </th:block>
                        </select>
                    </td>
                    <td style="text-align:right">
                        <button>Перевести</button>
                    </td>
                </tr>
            </table>
        </form>
    </td></tr>
    <tr><td style="padding:2px;" id="exchange_rates">
        Загрузка курсов валют...
    </td></tr>
</table>
</body>
</html>